@page "/qualifying/{RaceId:long}"
@inject BreadcrumbProvider _bread
@inject RaceService _raceService
@inject NavigationManager _nav
@inject IOptions<SimConfig> _config

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (!loading)
    {
        <CascadingValue Value="@Model">
            @if (Model.QualifyingFormat == QualyFormat.TripleEliminate)
            {
                <EliminationQualy CallbackFinish="Finish" />
            }
            else
            {
                <SingleSessionQualy CallbackFinish="Finish" />
            }
        </CascadingValue>
    }
</MudContainer>

@code {
    [Parameter] public long RaceId { get; set; }

    public QualifyingModel Model { get; set; }

    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        Model = await _raceService.RetrieveQualifyingModel(RaceId);

        _bread.SetBreadcrumbs(new List<BreadcrumbItem>()
        {
            new BreadcrumbItem("Home", href: ""),
            new BreadcrumbItem("Seasons", href: "seasons"),
            new BreadcrumbItem("Overview", href: $"overview/{Model.SeasonId}"),
            new BreadcrumbItem("Raceweek", href: $"raceweek/{RaceId}"),
            new BreadcrumbItem("Qualifying", href: $"qualifying/{RaceId}", disabled: true),
        });

        loading = false;
    }

    private async Task Finish()
    {
        // Check for the possible penalties and apply assigning new positions
        int positionIndexer = 0;
        var positionResults = Model.QualifyingDrivers
            .OrderBy(e => e.PenaltyPosition())
            .ToDictionary(e => e.ResultId, e => ++positionIndexer);
        var scoreResults = Model.QualifyingDrivers.SelectMany(e => e.ToScoreResults(RaceId)).ToList();

        await _raceService.PersistQualifyingResults(positionResults, RaceId, Model.MaximumRaceDrivers);
        await _raceService.PersistQualifyingScores(scoreResults);
        await _raceService.ConsumePenalties(Model.PenaltiesToConsume, RaceId);

        _nav.NavigateTo("/raceweek/" + RaceId);
    }
}
