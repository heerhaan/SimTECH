@inject IOptions<SimConfig> _config

<MudContainer Class="mt-4">
    @if (!loading)
    {
        <MudPaper MinHeight="60px">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.FlexEnd">
                <MudButtonGroup Color="Color.Tertiary" Variant="Variant.Outlined">
                    @if (!tempIsFinished)
                    {
                        @if (advancedRuns == amountRuns)
                        {
                            <MudButton OnClick="Finish">Finish</MudButton>
                        }
                        else
                        {
                            <MudButton OnClick="Advance">Advance</MudButton>
                        }
                    }
                </MudButtonGroup>
            </MudStack>
        </MudPaper>
        <MudPaper>
            <CommonSession
                Drivers="@practiceDrivers"
                Title="@raceName"
                Country="@raceCountry"
                AmountRuns="@amountRuns" />
        </MudPaper>
    }
</MudContainer>

@code {
    [CascadingParameter] public RaweCeekModel RaweCeek { get; set; }

    [Parameter] public int PracticeIndex { get; set; }
    [Parameter] public IEnumerable<PracticeScore> PracticeScores { get; set; } = Enumerable.Empty<PracticeScore>();
    [Parameter] public EventCallback OnFinish { get; set; }

    private List<SessionDriver> practiceDrivers = new();

    bool loading = true;
    bool tempIsFinished = false;
    string raceName = string.Empty;
    Country raceCountry = Constants.DefaultCountry;
    int amountRuns;
    int practiceRng;

    int advancedRuns;

    double gapMarge;

    protected override void OnInitialized()
    {
        gapMarge = _config.Value.GapMarge;
    }

    protected override void OnParametersSet()
    {
        loading = true;

        raceName = RaweCeek.Race.Name;
        raceCountry = RaweCeek.Race.Track.Country;
        amountRuns = RaweCeek.Season.RunAmountSession;

        var currentSessionScores = PracticeScores.Where(e => e.Index == PracticeIndex).ToList();

        foreach (var driver in RaweCeek.RaweCeekDrivers)
        {
            var mappedDriver = driver.MapToSessionDriver(amountRuns);

            var driverScore = PracticeScores.FirstOrDefault(e => e.ResultId == driver.ResultId && e.Index == PracticeIndex);
            if (driverScore != null && driverScore.Scores != null)
            {
                mappedDriver.Scores = driverScore.Scores;
                mappedDriver.Position = driverScore.Position;
            }

            practiceDrivers.Add(mappedDriver);
        }

        loading = false;
    }

    private void Advance()
    {
        var positionIndex = 0;

        foreach (var driver in practiceDrivers)
        {
            var result = driver.Power + NumberHelper.RandomInt(practiceRng);
            driver.Scores[advancedRuns] = result;
        }

        foreach (var driver in practiceDrivers.OrderByDescending(e => e.MaxScore()))
        {
            driver.Position = ++positionIndex;
        }

        advancedRuns++;
    }

    private async Task Finish()
    {
        //var positionResults = PracticeDataModel.PracticeDrivers.ToDictionary(e => e.ResultId, e => e.Position);
        //var actualResults = PracticeDataModel.PracticeDrivers.Select(e => e.ToScoreResult(RaceId, PracticeNum)).ToList();

        //await _raceService.PersistPracticeResults(positionResults);
        //await _raceService.PersistPracticeScores(actualResults);
    }
}
