<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.SsidChart" Class="mr-3 mb-n1"></MudIcon>
            Gapper race chart
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudContainer Class="pa-4" Style="min-width: 800px; min-height: 700px">
            @if (!loading)
            {
                <ApexCharts.ApexChart TItem="DataPoint" Title="Gaps to leader" Options="@options" Height="550">
                    @foreach (var driver in DataSets)
                    {
                        <ApexCharts.ApexPointSeries TItem="DataPoint"
                                            Items="@driver.DataPoints"
                                            Name="@driver.Label"
                                            SeriesType="ApexCharts.SeriesType.Line"
                                            XValue="@(e => e.XData)"
                                            YValue="@(e => e.YData)"
                                            OrderBy="e => e.X"
                                            Stroke="@driver.Stroke" />
                    }
                </ApexCharts.ApexChart>
            }
        </MudContainer>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter]
    protected MudDialogInstance? ChartDialog { get; set; }
    [Parameter, EditorRequired]
    public List<RaceDriver> Drivers { get; set; }

    ApexCharts.ApexChartOptions<DataPoint> options = new ApexCharts.ApexChartOptions<DataPoint>
        {
            Theme = new ApexCharts.Theme
            {
                Mode = ApexCharts.Mode.Dark,
            }
        };
    List<DataSet> DataSets = new();

    bool loading = true;

    protected override void OnInitialized()
    {
        var leaderScores = Drivers.First(e => e.Position == 1).LapScores;

        var seenTeamIdentifiers = new List<long>(Drivers.Count);

        foreach (var driver in Drivers)
        {
            var dataSet = new DataSet { Label = driver.FullName };

            int gap = 0;
            for (int i = 0; i < driver.LapScores.Count; i++)
            {
                var compareSet = leaderScores[i];
                var driverScore = driver.LapScores[i];

                gap += compareSet.Score - driverScore.Score;

                dataSet.DataPoints.Add(new DataPoint(compareSet.Order, gap));
            }

            var sameSeenTeams = seenTeamIdentifiers.Count(e => e == driver.SeasonTeamId);

            dataSet.Stroke = new ApexCharts.SeriesStroke { Color = driver.Colour, DashSpace = (2 * sameSeenTeams), Width = 3 };

            seenTeamIdentifiers.Add(driver.SeasonTeamId);
            DataSets.Add(dataSet);
        }

        loading = false;
    }
}
