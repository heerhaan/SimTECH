<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h5">Modify in-season driver</MudText>
    </TitleContent>
    <DialogContent>
        <MudContainer>
            <MudPaper MinWidth="750px">
                @if (!loading)
                {
                    <MudStack>
                        @if (Model.Id == 0 && Drivers != null)
                        {
                            <MudSelectExtended ItemCollection="@Drivers.ToList()"
                                               T="Driver"
                                               Label="Driver"
                                               Variant="Variant.Outlined"
                                               SearchBox="true"
                                               SearchFunc="SearchDrivers"
                                               Value="@Model.Driver"
                                               ValueChanged="LookupDriverData">
                                <ItemTemplate>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Class="pa-0">
                                        <MudText>@context.Value.FullName</MudText>
                                            <MudSpacer />
                                        <CountryFlag Code="@context.Value.Country" Size="ElementSize.Tiny" />
                                    </MudStack>
                                </ItemTemplate>
                            </MudSelectExtended>
                        }

                        <MudNumericField @bind-Value="Model.Number" Label="Number" Class="field-sm" />
                        <MudNumericField @bind-Value="Model.Skill" Label="Skill" Class="field-sm" />
                        <MudNumericField @bind-Value="Model.Reliability" Label="Reliability" Class="field-sm" />
                        <MudNumericField @bind-Value="Model.Attack" Label="Attack" Class="field-sm" />
                        <MudNumericField @bind-Value="Model.Defense" Label="Defense" Class="field-sm" />

                        <MudSelect T="TeamRole" @bind-Value="Model.TeamRole" Label="Team role" Style="width: 400px">
                            @foreach (var select in TeamRoleEnumHelper.GetTeamRoleSelection)
                            {
                                <MudSelectItem Value="select.Key">@select.Value</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSwitchM3 @bind-Checked="isDropped"
                                     ThumbIcon="@Icons.Material.Filled.Done"
                                     ThumbOffIcon="@Icons.Material.Filled.Close"
                                     Label="Drop driver from team?"
                                     Color="Color.Error" />

                        @if (!isDropped)
                        {
                            <MudSelect T="long" @bind-Value="seasonTeamId" Label="Team" Style="width: 400px">
                                @foreach (var steam in SeasonTeams)
                                {
                                    <MudSelectItem Value="steam.Id">@steam.Name</MudSelectItem>
                                }
                            </MudSelect>
                        }
                    </MudStack>
                }
            </MudPaper>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Ok</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] protected MudDialogInstance? DriverDialog { get; set; }

    [Parameter, EditorRequired] public long SeasonId { get; set; }
    [Parameter, EditorRequired] public List<SeasonTeam> SeasonTeams { get; set; }
    [Parameter] public IEnumerable<Driver> Drivers { get; set; } = Enumerable.Empty<Driver>();
    [Parameter] public SeasonDriver? SeasonDriver { get; set; }
    [Parameter] public int[] TakenNumbers { get; set; }

    private EditSeasonDriverModel Model;
    private long seasonTeamId;
    private bool loading = true;
    private bool isDropped = false;
    private int nextNumber;

    protected override void OnInitialized()
    {
        Model = new EditSeasonDriverModel(SeasonDriver);
        Model.SeasonId = SeasonId;
        seasonTeamId = Model.SeasonTeamId.GetValueOrDefault();
        Model.Number = TakenNumbers?.Max() + 1 ?? 2;

        loading = false;
    }

    private bool SearchDrivers(Driver driver, string searchText)
    {
        if (string.IsNullOrWhiteSpace(searchText))
            return true;

        var driverName = driver.FullName.ToLowerInvariant();

        return driverName.Contains(searchText.ToLowerInvariant());
    }

    private async Task LookupDriverData(Driver driver)
    {
        Model.DriverId = driver.Id;
        Model.Driver = driver;
    }

    private void Submit()
    {
        Model.SeasonTeamId = isDropped ? null : seasonTeamId;

        if (Model.IsDirty)
        {
            DriverDialog?.Close(DialogResult.Ok(Model.Record));
        }
    }

    private void Cancel() => DriverDialog?.Cancel();
}
