<MudDialog>
    <TitleContent>
        <MudText>Modify in-season driver</MudText>
    </TitleContent>
    <DialogContent>
        <MudContainer Class="min-width:500px">
            <MudForm Model="@Model">
                @if (Model.Id == 0 && Drivers != null)
                {
                    <MudSelect T="long" @bind-Value="@Model.DriverId" Label="Driver">
                        @foreach (var driver in Drivers)
                        {
                            <MudSelectItem Value="driver.Id">
                                <CountryFlag Code="driver.Country" Size="FlagSize.Tiny" />
                                @driver.FullName
                            </MudSelectItem>
                        }
                    </MudSelect>
                }

                <MudNumericField @bind-Value="@Model.Number" Label="Number" Class="field-sm" />
                <MudNumericField @bind-Value="@Model.Skill" Label="Skill" Class="field-sm" />
                <MudNumericField @bind-Value="@Model.Reliability" Label="Reliability" Class="field-sm" />
                <MudNumericField @bind-Value="@Model.Attack" Label="Attack" Class="field-sm" />
                <MudNumericField @bind-Value="@Model.Defense" Label="Defense" Class="field-sm" />

                <MudSelect T="TeamRole" @bind-Value="@Model.TeamRole" Label="Team Role">
                    @foreach (var select in EnumHelper.GetTeamRoleSelection())
                    {
                        <MudSelectItem Value="select.Key">@select.Value</MudSelectItem>
                    }
                </MudSelect>

                <MudSwitch @bind-Checked="@_isDropped" Label="Drop driver from team?" Color="Color.Error" />

                @if (!_isDropped)
                {
                    <MudSelect T="long" @bind-Value="@_seasonTeamId" Label="Team">
                        @foreach (var steam in SeasonTeams)
                        {
                            <MudSelectItem Value="steam.Id">
                                @steam.Name
                            </MudSelectItem>
                        }
                    </MudSelect>
                }
            </MudForm>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Ok</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] protected MudDialogInstance? DriverDialog { get; set; }

    [Parameter, EditorRequired] public long SeasonId { get; set; }
    [Parameter] public List<Driver>? Drivers { get; set; }
    [Parameter, EditorRequired] public List<SeasonTeam> SeasonTeams { get; set; }
    [Parameter] public SeasonDriver? SeasonDriver { get; set; }

    EditSeasonDriverModel Model;
    long _seasonTeamId;
    bool _isDropped = false;

    protected override void OnInitialized()
    {
        Model = new EditSeasonDriverModel(SeasonDriver);
        Model.SeasonId = SeasonId;
        _seasonTeamId = Model.SeasonTeamId.GetValueOrDefault();
    }

    private void Submit()
    {
        Model.SeasonTeamId = _isDropped ? null : _seasonTeamId;

        if (Model.IsDirty)
        {
            DriverDialog?.Close(DialogResult.Ok(Model.Record));
        }
    }

    private void Cancel() => DriverDialog?.Cancel();
}
