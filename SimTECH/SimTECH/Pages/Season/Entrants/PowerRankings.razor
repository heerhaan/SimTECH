@inject SeasonService SeasonService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="px-0">
    @if (DriverRankings != null)
    {
        <MudPaper MinHeight="60px">
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="pa-4">
                <MudText Typo="Typo.h3">Power rankings</MudText>
            </MudStack>
        </MudPaper>
        <MudDataGrid T="PowerRankModel" Items="@DriverRankings" Dense="true">
            <Columns>
                <HierarchyColumn T="PowerRankModel" />
                <TemplateColumn T="PowerRankModel" SortBy="e => e.DriverName" Title="Driver">
                    <CellTemplate>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="pa-0">
                            <MudText Typo="Typo.body2" Class="overflow-hider">@context.Item.DriverName</MudText>
                            <CountryFlag Code="@context.Item.Nationality" Size="ElementSize.Small" />
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn T="PowerRankModel"
                                SortBy="e => e.DriverNumber"
                                Title="NO"
                                HeaderClass="number-col hide-sort-icons"
                                CellClass="number-col">
                    <CellTemplate>
                        <NumberDisplay Colour="@context.Item.Colour" Accent="@context.Item.Accent">@context.Item.DriverNumber</NumberDisplay>
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="e => e.TeamName" Title="Team" CellClass="overflow-hider" CellStyleFunc="@SimpleCellStyle" />
                <PropertyColumn Property="e => e!.Engine" Title="Engine" HeaderClass="hide-sort-icons" />
                <PropertyColumn Property="e => e!.Manufacturer" Title="Supplier" HeaderClass="hide-sort-icons" />
                <PropertyColumn Property="e => e!.QualyPower" Title="Q.PWR" CellClass="font-caption" HeaderClass="hide-sort-icons" />
                <PropertyColumn Property="e => e!.RacePower" Title="R.PWR" CellClass="font-caption" HeaderClass="hide-sort-icons" />
                <TemplateColumn T="PowerRankModel" Title="A/C/P" Sortable="false">
                    <CellTemplate>
                        <MudText Typo="Typo.caption">@context.Item.Aero / @context.Item.Chassis / @context.Item.Powertrain</MudText>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn T="PowerRankModel" Title="Rel. avg." Sortable="false">
                    <CellTemplate>
                        <MudText Typo="Typo.caption">
                            @(NumberHelper.Average((context.Item.DriverRel + context.Item.CarRel + context.Item.EngineRel), 3))
                        </MudText>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <ChildRowContent>
                <MudText Color="Color.Warning">Should still be designed properly</MudText>
                <MudStack Row="true" Spacing="1">
                    <MudPaper Class="px-4 py-2">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudText>Driver reliability</MudText>
                            <MudDivider />
                            <MudText Typo="Typo.caption">@(context.Item.DriverRel)</MudText>
                        </MudStack>
                    </MudPaper>
                    <MudPaper Class="px-4 py-2">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudText>Car reliability</MudText>
                            <MudDivider />
                            <MudText Typo="Typo.caption">@(context.Item.CarRel)</MudText>
                        </MudStack>
                    </MudPaper>
                    <MudPaper Class="px-4 py-2">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudText>Engine reliability</MudText>
                            <MudDivider />
                            <MudText Typo="Typo.caption">@(context.Item.EngineRel)</MudText>
                        </MudStack>
                    </MudPaper>
                    <MudPaper Class="px-4 py-2">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudText>Wear modifiers</MudText>
                            <MudDivider />
                            <MudStack Row="true" Spacing="1" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="pa-0">
                                <MudText Typo="Typo.caption">@context.Item.WearMin</MudText>
                                <MudIcon Size="Size.Small" Icon="@IconCollection.ArrowMoveHorizontal" />
                                <MudText Typo="Typo.caption">@context.Item.WearMax</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                    <MudPaper Class="px-4 py-2">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudText>RNG modifiers</MudText>
                            <MudDivider />
                            @if (context.Item.TraitEffect != null)
                            {
                                <MudStack Row="true" Spacing="1" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="pa-0">
                                    <MudText Typo="Typo.caption">@context.Item.TraitEffect.MinRNG</MudText>
                                    <MudIcon Size="Size.Small" Icon="@IconCollection.ArrowMoveHorizontal" />
                                    <MudText Typo="Typo.caption">@context.Item.TraitEffect.MaxRNG</MudText>
                                </MudStack>
                            }
                        </MudStack>
                    </MudPaper>
                </MudStack>
            </ChildRowContent>
        </MudDataGrid>
    }
</MudContainer>

@code {
    [CascadingParameter] public Season Season { get; set; }

    List<PowerRankModel> DriverRankings;

    protected override async Task OnInitializedAsync()
    {
        DriverRankings = await SeasonService.GetPowerRankings(Season.Id);
    }

    private Func<PowerRankModel, string> SimpleCellStyle => power => ViewHelper.SetBorderRightStyle(power.Colour);
}
