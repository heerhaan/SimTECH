@page "/components/{SeasonId:long}"
@inject BreadcrumbProvider _bread
@inject IncidentService _incidentService
@inject SeasonService _seasonService

<PageTitle>Components</PageTitle>

<MudContainer>
    @if (driverComponentModel != null)
    {
        <MudGrid>
            <MudItem xs="9">
                <MudPaper Class="mud-height-full">
                    <MudPaper MinHeight="60px" Class="pa-4">
                        <MudText Typo="Typo.h3">Components</MudText>
                    </MudPaper>
                    <MudTable Items="@driverComponentModel" Dense="true">
                        <HeaderContent>
                            <MudTh>Name</MudTh>
                            <MudTh Class="number-col">NO</MudTh>
                            <MudTh>DNF</MudTh>
                            <MudTh>DSQ</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudText>@context.Name</MudText>
                            </MudTd>
                            <MudTd Class="number-col">
                                <NumberDisplay Colour="@context.Colour" Accent="@context.Accent">@context.Number</NumberDisplay>
                            </MudTd>
                            <MudTd>
                                <MudText Typo="Typo.caption">@context.TotalDnf</MudText>
                            </MudTd>
                            <MudTd>
                                <MudText Typo="Typo.caption">@context.TotalDsq</MudText>
                            </MudTd>
                        </RowTemplate>
                        <FooterContent>
                            <MudTd>LIMIT</MudTd>
                            <MudTd>TODO</MudTd>
                        </FooterContent>
                    </MudTable>
                </MudPaper>
            </MudItem>
            <MudItem xs="3">
                <MudPaper Class="pa-4 mud-height-full">
                    <MudText Typo="Typo.h5">Consumed penalties</MudText>
                    <MudList>
                        @foreach (var consum in consumedPenalties.OrderBy(e => e.Key))
                        {
                            <MudListItem Text="@consum.Key" InitiallyExpanded="true">
                                <NestedList>
                                    @foreach (var incidentale in consum.Value)
                                    {
                                        <MudListItem>
                                            <MudText>
                                                @incidentale.Consumed | @incidentale.Incident | @incidentale.Punishment
                                            </MudText>
                                        </MudListItem>
                                    }
                                </NestedList>
                            </MudListItem>
                        }
                    </MudList>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter] public long SeasonId { get; set; }

    private List<Incident> incidents;
    private List<PartsUsedByDriver> driverComponentModel;
    private Dictionary<string, List<PenaltyConsoom>> consumedPenalties = new();

    protected override async Task OnInitializedAsync()
    {
        _bread.SetBreadcrumbs(new List<BreadcrumbItem>()
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Seasons", href: "seasons}"),
            new BreadcrumbItem("Overview", href: $"overview/{SeasonId}"),
            new BreadcrumbItem("Components", href: $"components/{SeasonId}", disabled: true),
        });

        incidents = await _incidentService.GetIncidents();
        driverComponentModel = await _seasonService.GetPartsUsageModel(SeasonId);

        BuildConsumedPenalties();
    }

    private void BuildConsumedPenalties()
    {
        foreach (var driver in driverComponentModel.Where(e => e.GivenPenalties.Any()))
        {
            var consoom = new List<PenaltyConsoom>();
            foreach (var penalty in driver.GivenPenalties)
            {
                var inchident = incidents.Find(x => x.Id == penalty.IncidentId);
                consoom.Add(new PenaltyConsoom
                {
                    Consumed = penalty.Consumed,
                    Incident = inchident?.Name ?? "[Unknown]",
                    Punishment = inchident?.Punishment ?? 0,
                });
            }
            consumedPenalties.Add(driver.Name, consoom);
        }
    }

    internal class PenaltyConsoom
    {
        public bool Consumed { get; set; }
        public string Incident { get; set; }
        public int Punishment { get; set; }
    }
}
