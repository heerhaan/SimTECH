@page "/overview/{SeasonId:long}"
@page "/overview/{SeasonId:long}/{TabIndex:int}"
@inject ContractService _contractService
@inject ClimateService _climateService
@inject DriverService _driverService
@inject EngineService _engineService
@inject IncidentService _incidentService
@inject LeagueService _leagueService
@inject ManufacturerService _manufacturerService
@inject RaceService _raceService
@inject ResultService _resultService
@inject SeasonService _seasonService
@inject SeasonEntrantService _entrantService
@inject TeamService _teamService
@inject TrackService _trackService
@inject TraitService _traitService
@inject BreadcrumbProvider _bread
@inject NavigationManager _nav
@inject IDialogService _dialogService
@inject IOptions<SimConfig> _config
@inject ISnackbar _snackbar
@using SimTECH.Pages.Season.Development;
@using SimTECH.Pages.Season.Entrants;
@using SimTECH.Pages.Season.Stats;
@using SimTECH.Pages.Season.ScoreStandings

<PageTitle>Overview</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    @if (!loading)
    {
        <CascadingValue Value="@Season" IsFixed="true">
            <MudTabs Outlined="true" Centered="true" @bind-ActivePanelIndex="@activeTabIndex">
                <MudTabPanel Text="Overview">
                    <Landing
                        NextRace="@NextRace" 
                        OnStartSeason="StartSeason"
                        OnFinishSeason="FinishSeason"
                        OnShowComponentUsage="ShowUsedComponents"
                        OnShowQualyBattles="ShowQualyBattles"
                        OnNextRace="GoToNextRace"
                        OnClassSelected="SetActiveRaceClass"
                        OnNavigate="GoToCommon" />
                </MudTabPanel>
                <MudTabPanel Text="Calendar" OnClick="OnOpenCalendar">
                    @if (calendarLoaded)
                    {
                        <Calendar
                            Races="@Races"
                            Results="@Results"
                            SeasonDrivers="@OverviewModel.ClassDrivers()"
                            SeasonTeams="@OverviewModel.ClassTeams()"
                            Climates="@Climates"
                            OnAddRaces="AddRaces"
                            OnEditorOpen="UpdateRace"
                            OnDelete="DeleteRace"
                            OnGoToRace="GoToRace" />
                    }
                </MudTabPanel>
                <MudTabPanel Text="Standings" OnClick="OnOpenStandings">
                    @if (standingsLoaded)
                    {
                        <Standings SeasonDrivers="@OverviewModel.ClassDrivers()"
                                   SeasonTeams="@OverviewModel.ClassTeams()"
                                   Races="@Races"
                                   Results="@Results" />
                    }
                </MudTabPanel>
                <MudTabPanel Text="Entrants" OnClick="OnOpenDrivers">
                    <MudTabs Outlined="true" Centered="true">
                        <MudTabPanel Text="Drivers" OnClick="OnOpenDrivers">
                            @if (driversLoaded)
                            {
                                <SeasonDrivers
                                    DriverEntrants="@SeasonDrivers"
                                    SeasonTeams="@SeasonTeams"
                                    OnEditorOpen="UpdateDriver" />
                            }
                        </MudTabPanel>
                        <MudTabPanel Text="Teams" OnClick="OnOpenTeams">
                            @if (teamsLoaded)
                            {
                                <SeasonTeams
                                    TeamEntrants="@SeasonTeams"
                                    SeasonEngines="@SeasonEngines"
                                    Manufacturers="@Manufacturers"
                                    OnEditorOpen="UpdateTeam" />
                            }
                        </MudTabPanel>
                        <MudTabPanel Text="Engines" OnClick="OnOpenEngines">
                            @if (enginesLoaded)
                            {
                                <SeasonEngines
                                    EngineEntrants="@SeasonEngines"
                                    OnEditorOpen="UpdateEngine" />
                            }
                        </MudTabPanel>
                        <MudTabPanel Text="Power rankings" OnClick="OnOpenPower">
                            @if (powerLoaded)
                            {
                                <PowerRankings SeasonDrivers="@SeasonDrivers"
                                    SeasonTeams="@SeasonTeams"
                                    SeasonEngines="@SeasonEngines"
                                    Manufacturers="@Manufacturers"
                                    Traits="@Traits"
                                    TeamRoleCarModifier="@config.CarDriverStatusModifier" />
                            }
                        </MudTabPanel>
                    </MudTabs>
                </MudTabPanel>
                <MudTabPanel Text="Settings">
                    <Settings OnEditorOpen="UpdateSeason" />
                </MudTabPanel>
            </MudTabs>
        </CascadingValue>
    }
</MudContainer>

@code {
    [Parameter] public long SeasonId { get; set; }
    [Parameter] public int TabIndex { get; set; }

    public OverviewModel OverviewModel { get; set; } = new();

    [Obsolete] public Season Season { get; set; }
    public Race? NextRace { get; set; }
    public List<League> Leagues { get; set; } = new();
    [Obsolete] public List<Race> Races { get; set; } = new();
    public List<Result> Results { get; set; } = new();
    public List<Climate> Climates { get; set; } = new();
    [Obsolete] public List<SeasonEngine> SeasonEngines { get; set; } = new();
    [Obsolete] public List<SeasonTeam> SeasonTeams { get; set; } = new();
    [Obsolete] public List<SeasonDriver> SeasonDrivers { get; set; } = new();
    public List<Trait> Traits { get; set; } = new();
    public List<Manufacturer> Manufacturers { get; set; } = new();

    SimConfig config;

    int activeTabIndex = 0;
    bool loading = true;
    int nextRound;

    bool calendarLoaded = false;
    bool standingsLoaded = false;
    bool driversLoaded = false;
    bool teamsLoaded = false;
    bool enginesLoaded = false;
    bool powerLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        activeTabIndex = TabIndex;

        Season = await _seasonService.GetSeasonById(SeasonId);
        Races = await _raceService.GetRacesBySeason(SeasonId);

        OverviewModel.Season = await _seasonService.GetSeasonById(SeasonId);
        OverviewModel.Races = await _raceService.GetRacesBySeason(SeasonId);
        OverviewModel.SeasonEngines = await _entrantService.GetSeasonEngines(SeasonId);
        OverviewModel.SeasonTeams = await _entrantService.GetSeasonTeams(SeasonId);
        OverviewModel.SeasonDrivers = await _entrantService.GetSeasonDrivers(SeasonId);

        if (Season.State == State.Active)
        {
            NextRace = Races.FindNext();
            nextRound = NextRace?.Round ?? 0;
        }

        if (Season.HasRaceClasses)
        {
            OverviewModel.ActiveClassId = Season.RaceClasses.First().Id;
        }

        config = _config.Value;

        await PreloadTab(TabIndex);

        _bread.SetBreadcrumbs(new List<BreadcrumbItem>()
        {
            new BreadcrumbItem("Home", href: ""),
            new BreadcrumbItem("Seasons", href: "seasons"),
            new BreadcrumbItem("Overview", href: $"overview/{SeasonId}", disabled: true),
        });

        loading = false;
    }

    private async Task PreloadTab(int tabIndex)
    {
        switch (tabIndex)
        {
            case 1:
                await OnOpenCalendar();
                break;
            case 2:
                await OnOpenStandings();
                break;
            case 3:
                await OnOpenDrivers();
                break;
        }
    }

    private async Task OnOpenCalendar()
    {
        if (!Races.Any())
            Races = await _raceService.GetRacesBySeason(SeasonId);
        if (!Results.Any())
            Results = await _resultService.GetResultsOfSeason(SeasonId);
        if (!SeasonDrivers.Any())
            SeasonDrivers = await _entrantService.GetSeasonDrivers(SeasonId);
        if (!SeasonTeams.Any())
            SeasonTeams = await _entrantService.GetSeasonTeams(SeasonId);
        if (!Climates.Any())
            Climates = await _climateService.GetClimates(StateFilter.All);

        calendarLoaded = true;
    }

    private async Task OnOpenStandings()
    {
        if (!SeasonDrivers.Any())
            SeasonDrivers = await _entrantService.GetSeasonDrivers(SeasonId);
        if (!SeasonTeams.Any())
            SeasonTeams = await _entrantService.GetSeasonTeams(SeasonId);
        if (!Races.Any())
            Races = await _raceService.GetRacesBySeason(SeasonId);
        if (!Results.Any())
            Results = await _resultService.GetResultsOfSeason(SeasonId);

        standingsLoaded = true;
    }

    private async Task OnOpenDrivers()
    {
        if (!SeasonDrivers.Any())
            SeasonDrivers = await _entrantService.GetSeasonDrivers(SeasonId);
        if (!SeasonTeams.Any())
            SeasonTeams = await _entrantService.GetSeasonTeams(SeasonId);

        driversLoaded = true;
    }

    private async Task OnOpenTeams()
    {
        if (!SeasonTeams.Any())
            SeasonTeams = await _entrantService.GetSeasonTeams(SeasonId);
        if (!SeasonEngines.Any())
            SeasonEngines = await _entrantService.GetSeasonEngines(SeasonId);
        if (!Manufacturers.Any())
            Manufacturers = await _manufacturerService.GetManufacturers(StateFilter.All);

        teamsLoaded = true;
    }

    private async Task OnOpenEngines()
    {
        if (!SeasonEngines.Any())
            SeasonEngines = await _entrantService.GetSeasonEngines(SeasonId);

        enginesLoaded = true;
    }

    private async Task OnOpenPower()
    {
        if (!SeasonDrivers.Any())
            SeasonDrivers = await _entrantService.GetSeasonDrivers(SeasonId);
        if (!SeasonTeams.Any())
            SeasonTeams = await _entrantService.GetSeasonTeams(SeasonId);
        if (!SeasonEngines.Any())
            SeasonEngines = await _entrantService.GetSeasonEngines(SeasonId);
        if (!Manufacturers.Any())
            Manufacturers = await _manufacturerService.GetManufacturers(StateFilter.All);
        if (!Traits.Any())
            Traits = await _traitService.GetTraits(StateFilter.All);

        powerLoaded = true;
    }

    private async Task StartSeason()
    {
        if (Season != null)
        {
            var error = await _seasonService.ActivateSeason(SeasonId);

            if (error == null)
            {
                // Subtract active and added contract durations with 1 (if it is valid)
                await _contractService.SubtractDurations(Season.LeagueId, SeasonId);

                Season.State = State.Active; // NOTE: It always changes to active if started
                NextRace = await _raceService.GetNextRaceOfSeason(SeasonId);

                _snackbar.Add($"Season {Season.Year} has been activated!", Severity.Success);
                StateHasChanged();
            }
            else
            {
                _snackbar.Add(error, Severity.Error);
            }
        }
    }

    private async Task UpdateSeason()
    {
        var editModel = new EditSeasonModel(Season);

        if (Leagues == null)
            Leagues = await _leagueService.GetLeagues();

        var parameters = new DialogParameters { ["Model"] = editModel, ["Leagues"] = Leagues };

        var dialog = await _dialogService.ShowAsync<SeasonEditor>("Modify season", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null && result.Data is Season updatedItem)
        {
            await _seasonService.UpdateSeason(updatedItem);
            Season = updatedItem;
        }
    }

    private async Task FinishSeason()
    {
        bool? confirm = await _dialogService.ShowMessageBox(
            "Warning",
            "Are you sure you want to finish this season, this action cannot be undone!",
            yesText: "Yep", cancelText: "Nope");

        if (confirm == true)
        {
            await _seasonService.FinishSeason(SeasonId);
            _nav.NavigateTo("/seasons");
        }
    }

    private async Task SetActiveRaceClass(long raceClassId)
    {
        // If this is it, then we could use a bind
        OverviewModel.ActiveClassId = raceClassId;
    }

    private async Task AddRaces()
    {
        if (!Leagues.Any())
            Leagues = await _leagueService.GetLeagues();
        if (!Races.Any())
            Races = await _raceService.GetRacesBySeason(SeasonId);
        if (!Climates.Any())
            Climates = await _climateService.GetClimates(StateFilter.All);

        var league = Leagues.First(e => e.Id == Season.LeagueId);

        var usedTrackIds = Races.Select(e => e.TrackId).ToArray();
        var availableTracks = (await _trackService.GetTracks())
            .Where(e => !usedTrackIds.Contains(e.Id))
            .ToList();

        if (!availableTracks.Any())
        {
            _snackbar.Add("there aren't any tracks left to add to this season, ya absolute willy", Severity.Error);
            return;
        }

        var parameters = new DialogParameters
            {
                ["Tracks"] = availableTracks,
                ["SeasonId"] = SeasonId,
                ["OffsetRound"] = 1 + Races.Count(),
                ["DefaultRaceLength"] = league.RaceLength,
                ["Climates"] = Climates.Where(e => e.State == State.Active).ToList(),
            };

        var dialog = await _dialogService.ShowAsync<AddRaces>("Insert races", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null && result.Data is List<Race> addedRaces)
        {
            await _raceService.InsertRaces(addedRaces);
            Races = await _raceService.GetRacesBySeason(SeasonId);
        }
    }

    private async Task UpdateRace(Race? item)
    {
        if (!Leagues.Any())
            Leagues = await _leagueService.GetLeagues();

        var currentLeague = Leagues.First(e => e.Id == Season.LeagueId);

        var parameters = new DialogParameters
            {
                ["Race"] = item,
                ["SeasonId"] = SeasonId,
                ["Climates"] = Climates.Where(e => e.State == State.Active).ToList(),
            };

        var dialog = await _dialogService.ShowAsync<RaceEditor>("Modify Race", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null && result.Data is Race updatedRace)
        {
            await _raceService.UpdateRace(updatedRace);
            Races = await _raceService.GetRacesBySeason(SeasonId);
        }
    }

    private async Task DeleteRace(long raceId)
    {
        await _raceService.DeleteRace(raceId);
        Races = await _raceService.GetRacesBySeason(SeasonId);
    }

    private async Task GoToNextRace() => await GoToRace(nextRound);

    private async Task GoToRace(int round)
    {
        if (!Races.Any())
            Races = await _raceService.GetRacesBySeason(SeasonId);

        var race = Races.FirstOrDefault(e => e.Round == round);
        if (race is null)
        {
            _snackbar.Add("can't find the next race, you sure it exists lad?");
            return;
        }

        if (race.State == State.Concept)
        {
            if (race.Round != nextRound)
            {
                _snackbar.Add("oi oi oi, a previous round hasn't been finished (or even started!) yet. do that one first, cunt.", Severity.Error);
                return;
            }

            await _raceService.ActivateRace(race.Id);
        }

        _nav.NavigateTo($"/raceweek/{race.Id}");
    }

    private async Task UpdateDriver(SeasonDriver? item)
    {
        if (!SeasonTeams.Any())
            SeasonTeams = await _entrantService.GetSeasonTeams(SeasonId);

        var drivers = await _driverService.GetAvailableDrivers();

        var parameters = new DialogParameters
            {
                ["SeasonId"] = Season.Id,
                ["SeasonTeams"] = SeasonTeams,
                ["Drivers"] = drivers,
                ["SeasonDriver"] = item,
            };

        var dialog = await _dialogService.ShowAsync<SeasonDriverEditor>("Modify in-season driver", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null && result.Data is SeasonDriver updatedDriver)
        {
            await _entrantService.UpdateSeasonDriver(updatedDriver);
            SeasonDrivers = await _entrantService.GetSeasonDrivers(SeasonId);
        }
    }

    private async Task UpdateTeam(SeasonTeam? item)
    {
        if (!Manufacturers.Any())
            Manufacturers = await _manufacturerService.GetManufacturers(StateFilter.All);
        if (!SeasonEngines.Any())
            SeasonEngines = await _entrantService.GetSeasonEngines(SeasonId);

        var teams = await _teamService.GetAvailableTeams();

        var parameters = new DialogParameters
            {
                ["SeasonId"] = SeasonId,
                ["Teams"] = teams,
                ["Manufacturers"] = Manufacturers.Where(e => e.State == State.Active).ToList(),
                ["SeasonEngines"] = SeasonEngines,
                ["SeasonTeam"] = item,
            };

        var dialog = await _dialogService.ShowAsync<SeasonTeamEditor>("Modify in-season team", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null && result.Data is SeasonTeam updatedTeam)
        {
            await _entrantService.UpdateSeasonTeam(updatedTeam);
            SeasonTeams = await _entrantService.GetSeasonTeams(SeasonId);
        }
    }

    private async Task UpdateEngine(SeasonEngine? item)
    {
        var engines = await _engineService.GetEngines();
        var parameters = new DialogParameters
            {
                ["SeasonId"] = SeasonId,
                ["Engines"] = engines,
                ["SeasonEngine"] = item,
            };

        var dialog = await _dialogService.ShowAsync<SeasonEngineEditor>("Modify in-season engine", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null && result.Data is SeasonEngine updatedEngine)
        {
            await _entrantService.UpdateSeasonEngine(updatedEngine);

            var seasonEngine = SeasonEngines.FirstOrDefault(e => e.Id == updatedEngine.Id);
            SeasonEngines = await _entrantService.GetSeasonEngines(SeasonId);
        }
    }

    private async Task ShowQualyBattles()
    {
        if (!SeasonDrivers.Any())
            SeasonDrivers = await _entrantService.GetSeasonDrivers(SeasonId);
        if (!SeasonTeams.Any())
            SeasonTeams = await _entrantService.GetSeasonTeams(SeasonId);
        if (!Results.Any())
            Results = await _resultService.GetResultsOfSeason(SeasonId);

        var parameters = new DialogParameters
            {
                ["SeasonDrivers"] = SeasonDrivers,
                ["SeasonTeams"] = SeasonTeams,
                ["Results"] = Results
            };

        _ = await _dialogService.ShowAsync<QualyBattles>("QualifyingBattles", parameters);
    }

    private async Task ShowUsedComponents()
    {
        if (!SeasonDrivers.Any())
            SeasonDrivers = await _entrantService.GetSeasonDrivers(SeasonId);
        if (!SeasonTeams.Any())
            SeasonTeams = await _entrantService.GetSeasonTeams(SeasonId);
        if (!Results.Any())
            Results = await _resultService.GetResultsOfSeason(SeasonId);

        var incidents = await _incidentService.GetIncidents(StateFilter.Default);

        var parameters = new DialogParameters
            {
                ["SeasonDrivers"] = SeasonDrivers,
                ["SeasonTeams"] = SeasonTeams,
                ["Results"] = Results,
                ["Incidents"] = incidents,
            };

        _ = await _dialogService.ShowAsync<UsedComponents>("UsedComponents", parameters);
    }

    private void GoToCommon(string path) => _nav.NavigateTo(path);
}
