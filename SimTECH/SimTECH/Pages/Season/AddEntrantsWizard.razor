@page "/addentrantswizard/{SeasonId:long}"
@using MudBlazor.Extensions
@using MudExtensions
@using MudExtensions.Enums;
@using MudExtensions.Utilities

@inject EngineService EngineService
@inject TeamService TeamService
@inject DriverService DriverService
@inject SeasonService SeasonService
@inject SeasonEntrantService EntrantService
@inject ManufacturerService ManufacturerService
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject IOptions<SimConfig> _config

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudStepper @ref="_stepper" Loading="_loading" Variant="Variant.Outlined" Linear="true" DisableSkipButton="true"
                PreventStepChangeAsync="new Func<StepChangeDirection, Task<bool>>(StepValidator)">
        <StaticContent>
            <MudPaper>
                <MudText>In this field you'll see any sort of feedback on the current step</MudText>
                @if (_feedbackValidations != null)
                {
                    @foreach (var feedback in _feedbackValidations)
                    {
                        <MudAlert Severity="Severity.Error">@feedback</MudAlert>
                    }
                }
            </MudPaper>
        </StaticContent>
        <ChildContent>
            <MudStep Title="Participating engines" Icon="@IconCollection.Engine">
                <ChildContent>
                    <MudContainer MaxWidth="MaxWidth.Medium">
                        <MudPaper>
                            @if (!_loading)
                            {
                                <MudTable T="Engine" Items="@engines" @bind-SelectedItems="@Model.BaseEngines" MultiSelection="true" Dense="true" Hover="true">
                                    <ToolBarContent>
                                        <MudText Typo="Typo.h5">Available engines</MudText>
                                    </ToolBarContent>
                                    <HeaderContent>
                                        <MudTh>Name</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="Name">@context.Name</MudTd>
                                    </RowTemplate>
                                </MudTable>
                            }
                        </MudPaper>
                    </MudContainer>
                </ChildContent>
            </MudStep>
            <MudStep Title="Modify engines" Icon="@IconCollection.Engine">
                <ChildContent>
                    <MudContainer MaxWidth="MaxWidth.Large">
                        <MudPaper>
                            @if (!_loading)
                            {
                                <MudForm Model="Model.SeasonEngines" @ref="_engineForm">
                                    <MudTable T="EditSeasonEngineModel" Items="@Model.SeasonEngines" Hover="true">
                                        <HeaderContent>
                                            <MudTh>Name</MudTh>
                                            <MudTh>Power</MudTh>
                                            <MudTh>Reliability</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="Name">
                                                <MudText Typo="Typo.caption">@context.Name</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Power">
                                                <MudText Typo="Typo.caption">@context.Power</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Reliability">
                                                <MudText Typo="Typo.caption">@context.Reliability</MudText>
                                            </MudTd>
                                        </RowTemplate>
                                        <RowEditingTemplate>
                                            <MudTd DataLabel="Name">
                                                <MudTextField @bind-Value="@context.Name" Required />
                                            </MudTd>
                                            <MudTd DataLabel="Power">
                                                <MudNumericField @bind-Value="@context.Power" />
                                            </MudTd>
                                            <MudTd DataLabel="Reliability">
                                                <MudNumericField @bind-Value="@context.Reliability" />
                                            </MudTd>
                                        </RowEditingTemplate>
                                        <EditButtonContent Context="button">
                                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Class="pa-0" OnClick="@button.ButtonAction" />
                                        </EditButtonContent>
                                    </MudTable>
                                </MudForm>
                            }
                        </MudPaper>
                    </MudContainer>
                </ChildContent>
            </MudStep>
            <MudStep Title="Participating teams" Icon="@IconCollection.Car">
                <ChildContent>
                    <MudContainer MaxWidth="MaxWidth.Medium">
                        <MudPaper>
                            @if (!_loading)
                            {
                                <MudTable T="Team" Items="@teams" @bind-SelectedItems="@Model.BaseTeams" MultiSelection="true" Dense="true" Hover="true">
                                    <ToolBarContent>
                                        <MudText Typo="Typo.h5">Available teams</MudText>
                                    </ToolBarContent>
                                    <HeaderContent>
                                        <MudTh>Name</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="Name">
                                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                                <MudText>@context.Name</MudText>
                                                <MudSpacer />
                                                <CountryFlag Code="@context.Country" />
                                            </MudStack>
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>
                            }
                        </MudPaper>
                    </MudContainer>
                </ChildContent>
            </MudStep>
            <MudStep Title="Modify teams" Icon="@IconCollection.Car">
                <ChildContent>
                    <MudContainer MaxWidth="MaxWidth.ExtraLarge">
                        <MudForm Model="@Model.SeasonTeams" @ref="_teamForm">
                            <MudPaper>
                                @if (!_loading)
                                {
                                    <MudTable T="EditSeasonTeamModel" Items="@Model.SeasonTeams" Hover="true">
                                        <HeaderContent>
                                            <MudTh Style="min-width: 200px;">Team</MudTh>
                                            <MudTh Style="min-width: 200px;">Name</MudTh>
                                            <MudTh Style="min-width: 200px;">Principal</MudTh>
                                            <MudTh Style="min-width: 100px;">Colour</MudTh>
                                            <MudTh Style="min-width: 100px;">Accent</MudTh>
                                            <MudTh Style="min-width: 50px;">Base</MudTh>
                                            <MudTh Style="min-width: 50px;">Aero</MudTh>
                                            <MudTh Style="min-width: 50px;">Chassis</MudTh>
                                            <MudTh Style="min-width: 50px;">Powertrain</MudTh>
                                            <MudTh Style="min-width: 50px;">Reliability</MudTh>
                                            <MudTh Style="min-width: 200px;">Manufacturer</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="Team">
                                                <MudText>@(context.Team?.Name ?? "Unknown")</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Name">
                                                <MudText>@context.Name</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Principal">
                                                <MudText>@context.Principal</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Colour" Style="@ViewHelper.SetBackgroundColour(context.Colour)">
                                                @context.Colour
                                            </MudTd>
                                            <MudTd DataLabel="Accent" Style="@ViewHelper.SetBackgroundColour(context.Accent)">
                                                @context.Accent
                                            </MudTd>
                                            <MudTd DataLabel="Base">
                                                <MudText Typo="Typo.caption">@context.BaseValue</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Aero">
                                                <MudText Typo="Typo.caption">@context.Aero</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Chassis">
                                                <MudText Typo="Typo.caption">@context.Chassis</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Powertrain">
                                                <MudText Typo="Typo.caption">@context.Powertrain</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Reliability">
                                                <MudText Typo="Typo.caption">@context.Reliability</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Manufacturer">
                                                <MudText>@ReadManufacturerName(context.ManufacturerId)</MudText>
                                            </MudTd>
                                        </RowTemplate>
                                        <RowEditingTemplate>
                                            <MudTd DataLabel="Team">
                                                <MudText>@(context.Team?.Name ?? "Unknown")</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Name">
                                                <MudTextField @bind-Value="@context.Name" Required />
                                            </MudTd>
                                            <MudTd DataLabel="Principal">
                                                <MudTextField @bind-Value="@context.Principal" Required />
                                            </MudTd>
                                            <MudTd DataLabel="Colour">
                                                <MudColorPicker @bind-Text="@context.Colour" DisableAlpha="true" />
                                            </MudTd>
                                            <MudTd DataLabel="Accent">
                                                <MudColorPicker @bind-Text="@context.Accent" DisableAlpha="true" />
                                            </MudTd>
                                            <MudTd DataLabel="Base">
                                                <MudNumericField @bind-Value="@context.BaseValue" />
                                            </MudTd>
                                            <MudTd DataLabel="Aero">
                                                <MudNumericField @bind-Value="@context.Aero" />
                                            </MudTd>
                                            <MudTd DataLabel="Chassis">
                                                <MudNumericField @bind-Value="@context.Chassis" />
                                            </MudTd>
                                            <MudTd DataLabel="Powertrain">
                                                <MudNumericField @bind-Value="@context.Powertrain" />
                                            </MudTd>
                                            <MudTd DataLabel="Reliability">
                                                <MudNumericField @bind-Value="@context.Reliability" />
                                            </MudTd>
                                            <MudTd DataLabel="Manufacturer">
                                                <MudSelect T="long" @bind-Value="@context.ManufacturerId" Required>
                                                @foreach (var manufacturer in manufacturers)
                                                    {
                                                        <MudSelectItem Value="manufacturer.Id">@manufacturer.Name</MudSelectItem>
                                                    }
                                                </MudSelect>
                                            </MudTd>
                                        </RowEditingTemplate>
                                        <EditButtonContent Context="button">
                                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Class="pa-0" OnClick="@button.ButtonAction" />
                                        </EditButtonContent>
                                    </MudTable>
                                }
                            </MudPaper>
                        </MudForm>
                    </MudContainer>
                </ChildContent>
            </MudStep>
            <MudStep Title="Assign engines to teams" Icon="@IconCollection.Car">
                <ChildContent>
                    <MudContainer MaxWidth="MaxWidth.ExtraLarge">
                        <MudPaper Class="mud-height-full">
                            @if (!_loading)
                            {
                                <MudDropContainer T="EditSeasonTeamModel" @ref="_dropperTeams" Items="@Model.SeasonTeams" ItemsSelector="@((item,dropzone) => item.BaseEngineId.ToString() == dropzone)" ItemDropped="TeamEngineDropped" Class="d-flex flex-wrap flex-grow-1">
                                    <ChildContent>
                                        <MudStack Row="true">
                                            <MudPaper Class="ma-2" Width="225px">
                                                <MudList Clickable="true">
                                                    <MudListSubheader>Unassigned teams</MudListSubheader>
                                                    <MudDropZone T="EditSeasonTeamModel" Identifier="0" Style="min-height:200px" />
                                                </MudList>
                                            </MudPaper>
                                            @foreach (var seasonEngine in Model.SeasonEngines)
                                            {
                                                <MudPaper Class="ma-2" Width="225px">
                                                    <MudList Clickable="true">
                                                        <MudListSubheader>
                                                            Engine: @seasonEngine.Name
                                                        </MudListSubheader>
                                                        <MudDropZone T="EditSeasonTeamModel" Identifier="@seasonEngine.EngineId.ToString()" Style="min-height:200px" />
                                                    </MudList>
                                                </MudPaper>
                                            }
                                        </MudStack>
                                    </ChildContent>
                                    <ItemRenderer>
                                        <MudListItem Text="@context.Name" />
                                    </ItemRenderer>
                                </MudDropContainer>
                            }
                        </MudPaper>
                    </MudContainer>
                </ChildContent>
            </MudStep>
            <MudStep Title="Participating drivers" Icon="@IconCollection.Helmet">
                <ChildContent>
                    <MudContainer MaxWidth="MaxWidth.Large">
                        <MudPaper>
                            @if (!_loading)
                            {
                                <MudTable T="Driver" @bind-SelectedItems="@Model.BaseDrivers" Items="@drivers" MultiSelection="true" Dense="true" Hover="true">
                                    <ToolBarContent>
                                        <MudText Typo="Typo.h5">Available drivers</MudText>
                                    </ToolBarContent>
                                    <HeaderContent>
                                        <MudTh>Name</MudTh>
                                        <MudTh>Age</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="Name">
                                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                                <MudText>@context.FullName</MudText>
                                                <MudSpacer />
                                                <CountryFlag Code="@context.Country" />
                                            </MudStack>
                                        </MudTd>
                                        <MudTd>
                                            <MudText Typo="Typo.caption">@(Season.Year - context.DateOfBirth.Year)</MudText>
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>
                            }
                        </MudPaper>
                    </MudContainer>
                </ChildContent>
            </MudStep>
            <MudStep Title="Modify drivers" Icon="@IconCollection.Helmet">
                <ChildContent>
                    <MudContainer MaxWidth="MaxWidth.ExtraLarge">
                        <MudPaper>
                            @if (!_loading)
                            {
                                <MudForm @ref="_driverForm" Model="@Model.SeasonDrivers">
                                    <MudTable T="EditSeasonDriverModel" Items="@Model.SeasonDrivers" Hover="true">
                                        <HeaderContent>
                                            <MudTh>Name</MudTh>
                                            <MudTh>Number</MudTh>
                                            <MudTh>Skill</MudTh>
                                            <MudTh>Reliability</MudTh>
                                            <MudTh>TeamRole</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="Name">
                                                <MudStack Row="true" Spacing="1" Class="align-center">
                                                    <MudText>@context.Driver.FullName</MudText>
                                                    <MudSpacer />
                                                    <CountryFlag Code="@context.Driver.Country" Size="FlagSize.Small" />
                                                </MudStack>
                                            </MudTd>
                                            <MudTd DataLabel="Number">
                                                <MudText Typo="Typo.caption">@context.Number</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Skill">
                                                <MudText Typo="Typo.caption">@context.Skill</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Reliability">
                                                <MudText Typo="Typo.caption">@context.Reliability</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="TeamRole">
                                                <MudText>@context.TeamRole</MudText>
                                            </MudTd>
                                        </RowTemplate>
                                        <RowEditingTemplate>
                                            <MudTd DataLabel="Name">
                                                <MudStack Row="true" Spacing="1" Class="align-center">
                                                    <MudText>@context.Driver.FullName</MudText>
                                                    <MudSpacer />
                                                    <CountryFlag Code="@context.Driver.Country" Size="FlagSize.Small" />
                                                </MudStack>
                                            </MudTd>
                                            <MudTd DataLabel="Number">
                                                <MudNumericField @bind-Value="@context.Number" />
                                            </MudTd>
                                            <MudTd DataLabel="Skill">
                                                <MudNumericField @bind-Value="@context.Skill" />
                                            </MudTd>
                                            <MudTd DataLabel="Reliability">
                                                <MudNumericField @bind-Value="@context.Reliability" />
                                            </MudTd>
                                            <MudTd DataLabel="TeamRole">
                                                <MudSelect T="TeamRole" @bind-Value="@context.TeamRole">
                                                    @foreach (var select in EnumHelper.GetTeamRoleSelection())
                                                    {
                                                        <MudSelectItem Value="select.Key">@select.Value</MudSelectItem>
                                                    }
                                                </MudSelect>
                                            </MudTd>
                                        </RowEditingTemplate>
                                        <EditButtonContent Context="button">
                                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Class="pa-0" OnClick="@button.ButtonAction" />
                                        </EditButtonContent>
                                    </MudTable>
                                </MudForm>
                            }
                        </MudPaper>
                    </MudContainer>
                </ChildContent>
            </MudStep>
            <MudStep Title="Assign drivers to teams" Icon="@IconCollection.Helmet">
                <ChildContent>
                    <MudContainer MaxWidth="MaxWidth.ExtraLarge">
                        <MudPaper Class="mud-height-full">
                            @if (!_loading)
                            {
                                <MudDropContainer T="EditSeasonDriverModel" @ref="_dropperDrivers" Items="@Model.SeasonDrivers" ItemsSelector="@((item,dropzone) => item.BaseTeamId.ToString() == dropzone)" ItemDropped="DriverTeamDropped" Class="d-flex flex-row flex-wrap flex-grow-1">
                                    <ChildContent>
                                        <MudPaper Class="ma-2" Width="225px">
                                            <MudList Clickable="true">
                                                <MudListSubheader>Unassigned drivers</MudListSubheader>
                                                <MudDropZone T="EditSeasonDriverModel" Identifier="0" Style="min-height:200px" />
                                            </MudList>
                                        </MudPaper>
                                        @foreach (var seasonTeam in Model.SeasonTeams)
                                        {
                                            <MudPaper Class="ma-2" Width="225px">
                                                <MudList Clickable="true">
                                                    <MudListSubheader>
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="pa-0">
                                                            <MudText>@seasonTeam.Name</MudText>
                                                            <MudSpacer />
                                                            <CountryFlag Code="@seasonTeam.Team.Country" />
                                                        </MudStack>
                                                    </MudListSubheader>
                                                    <MudDropZone T="EditSeasonDriverModel" Identifier="@seasonTeam.TeamId.ToString()" Style="min-height:200px" />
                                                </MudList>
                                            </MudPaper>
                                        }
                                    </ChildContent>
                                    <ItemRenderer>
                                        <MudListItem>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Class="pa-0">
                                                <MudText>@context.Driver.FullName</MudText>
                                                <MudSpacer />
                                                <CountryFlag Code="@context.Driver.Country" Size="FlagSize.Small" />
                                            </MudStack>
                                        </MudListItem>
                                    </ItemRenderer>
                                </MudDropContainer>
                            }
                        </MudPaper>
                    </MudContainer>
                </ChildContent>
            </MudStep>
            <MudStep Title="Entries for season" IsResultStep="true" Icon="@Icons.Material.Filled.Flag">
                <ChildContent>
                    <MudContainer MaxWidth="MaxWidth.False">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudPaper>
                                    <MudStack>
                                        <MudText>Season participants</MudText>
                                        <MudSpacer />
                                        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="AddAllEntrants">Confirm and save</MudButton>
                                    </MudStack>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6">
                                <MudPaper>
                                    <MudTable Items="@Model.SeasonDrivers">
                                        <ToolBarContent>
                                            <MudText Typo="Typo.h6">Participating drivers</MudText>
                                        </ToolBarContent>
                                        <HeaderContent>
                                            <MudTh>Name</MudTh>
                                            <MudTh>Number</MudTh>
                                            <MudTh>Skill</MudTh>
                                            <MudTh>Reliability</MudTh>
                                            <MudTh>TeamRole</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="Name">
                                                <MudStack Row="true" Spacing="1" Class="align-center">
                                                    <MudText>@context.Driver.FullName</MudText>
                                                    <MudSpacer />
                                                    <CountryFlag Code="@context.Driver.Country" Size="FlagSize.Small" />
                                                </MudStack>
                                            </MudTd>
                                            <MudTd DataLabel="Number">
                                                <MudText Typo="Typo.caption">@context.Number</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Skill">
                                                <MudText Typo="Typo.caption">@context.Skill</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Reliability">
                                                <MudText Typo="Typo.caption">@context.Reliability</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="TeamRole">
                                                <MudText>@context.TeamRole</MudText>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6">
                                <MudPaper>
                                    <MudTable Items="@Model.SeasonEngines">
                                        <ToolBarContent>
                                            <MudText Typo="Typo.h6">Participating engines</MudText>
                                        </ToolBarContent>
                                        <HeaderContent>
                                            <MudTh>Name</MudTh>
                                            <MudTh>Power</MudTh>
                                            <MudTh>Reliability</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="Name">
                                                <MudText>@context.Name</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Power">
                                                <MudText Typo="Typo.caption">@context.Power</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Reliability">
                                                <MudText Typo="Typo.caption">@context.Reliability</MudText>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12">
                                <MudPaper>
                                    <MudTable Items="@Model.SeasonTeams">
                                        <ToolBarContent>
                                            <MudText Typo="Typo.h6">Participating teams</MudText>
                                        </ToolBarContent>
                                        <HeaderContent>
                                            <MudTh>Name</MudTh>
                                            <MudTh>Principal</MudTh>
                                            <MudTh>Colour</MudTh>
                                            <MudTh>Accent</MudTh>
                                            <MudTh>BaseValue</MudTh>
                                            <MudTh>Aero</MudTh>
                                            <MudTh>Chassis</MudTh>
                                            <MudTh>Powertrain</MudTh>
                                            <MudTh>Reliability</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="Name">
                                                <MudStack Row="true" Spacing="1" Class="align-center">
                                                    <MudText>@context.Name</MudText>
                                                    <MudSpacer />
                                                    <CountryFlag Code="@context.Team.Country" Size="FlagSize.Small" />
                                                </MudStack>
                                            </MudTd>
                                            <MudTd DataLabel="Principal">
                                                <MudText>@context.Principal</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Colour">
                                                @context.Colour
                                            </MudTd>
                                            <MudTd DataLabel="Accent">
                                                @context.Accent
                                            </MudTd>
                                            <MudTd DataLabel="BaseValue">
                                                <MudText Typo="Typo.caption">@context.BaseValue</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Aero">
                                                <MudText Typo="Typo.caption">@context.Aero</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Chassis">
                                                <MudText Typo="Typo.caption">@context.Chassis</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Powertrain">
                                                <MudText Typo="Typo.caption">@context.Powertrain</MudText>
                                            </MudTd>
                                            <MudTd DataLabel="Reliability">
                                                <MudText Typo="Typo.caption">@context.Reliability</MudText>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    </MudContainer>
                </ChildContent>
            </MudStep>
        </ChildContent>
    </MudStepper>
</MudContainer>

@code {
    [Parameter] public long SeasonId { get; set; }

    public Season Season = new();
    public AddEntrantsModel Model = new();

    Season? PreviousSeason;
    List<Engine> engines;
    List<Team> teams;
    List<Driver> drivers;
    List<Manufacturer> manufacturers;

    MudStepper _stepper;
    MudForm _engineForm;
    MudForm _teamForm;
    MudForm _driverForm;
    MudDropContainer<EditSeasonTeamModel> _dropperTeams;
    MudDropContainer<EditSeasonDriverModel> _dropperDrivers;
    bool _loading = false;
    string[]? _feedbackValidations;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;

        Season = await SeasonService.GetSeasonById(SeasonId);
        PreviousSeason = await SeasonService.FindRecentClosedSeason(Season.LeagueId);

        // You might want to add these bad boys to the individual step actions instead of doing it all at once
        // Retrieve the existing base engines
        engines = await EngineService.GetEngines();
        //teams = await TeamService.GetTeams();
        //drivers = await DriverService.GetDrivers();
        manufacturers = await ManufacturerService.GetManufacturers();

        _loading = false;
    }

    private async Task<bool> StepValidator(StepChangeDirection direction)
    {
        if (direction == StepChangeDirection.Backward)
            return false;

        var validationMessages = new List<string>();
        _loading = true;

        switch (_stepper.GetActiveIndex())
        {
            case 0: //Step: adding engines to season
                {
                    if (Model.BaseEngines?.Any() == true)
                    {
                        await SetDefaultEngines();
                    }
                    else
                    {
                        validationMessages.Add("Suggestion: add some goddamn engines to the season");
                    }
                }
                break;
            case 1: //Step: editing entered engines
                await _engineForm.Validate();
                if (!_engineForm.IsValid)
                {
                    validationMessages.Add("You fucked up a field somewhere, try again");
                }
                else
                {
                    teams = await TeamService.GetTeams();
                }
                break;
            case 2: //Step: adding teams to season
                {
                    if (Model.BaseTeams?.Any() == true)
                    {
                        await SetDefaultTeams();
                    }
                    else
                    {
                        validationMessages.Add("Suggestion: add some goddamn teams to the season");
                    }
                }
                break;
            case 3: //Step: editing teams
                await _teamForm.Validate();
                if (!_teamForm.IsValid)
                {
                    validationMessages.Add("You fucked up a field somewhere, try again");
                }
                else if (Model.SeasonTeams.Any(e => e.ManufacturerId == 0))
                {
                    validationMessages.Add("Not all teams have a tyre manufacturer, considering this isn't a boat race means you're going to have to add that also");
                }
                RefreshTeamEngine();
                break;
            case 4: //Step: team assignment
                if (Model.SeasonTeams.Any(e => e.BaseEngineId == 0))
                {
                    validationMessages.Add("Oi oi mate, how is a team going to drive without an engine? Try again");
                }
                else
                {
                    drivers = await DriverService.GetDrivers();
                }
                break;
            case 5: //Step: adding drivers
                {
                    if (Model.BaseDrivers?.Any() == true)
                    {
                        await SetDefaultDrivers();
                    }
                    else
                    {
                        validationMessages.Add("Suggestion: add some goddamn drivers to the season");
                    }
                }
                break;
            case 6: //Step: editing drivers
                await _driverForm.Validate();
                if (!_driverForm.IsValid)
                {
                    validationMessages.Add("You fucked up a field somewhere, try again");
                }
                RefreshDriverTeam();
                break;
            case 7: //Step: driver assignment
                break;
            default:
                break;
        }

        _loading = false;
        StateHasChanged();

        if (validationMessages.Any())
        {
            _feedbackValidations = validationMessages.ToArray();
            return true;
        }

        _feedbackValidations = null;
        return false;
    }

    private async Task SetDefaultEngines()
    {
        List<SeasonEngine>? previousEngines = null;
        if (PreviousSeason != null)
            previousEngines = await EntrantService.GetSeasonEngines(PreviousSeason.Id);

        foreach (var engine in Model.BaseEngines)
        {
            SeasonEngine? previousEngine = null;
            if (previousEngines != null)
                previousEngine = previousEngines.Find(e => e.EngineId == engine.Id);

            var model = new EditSeasonEngineModel(previousEngine);
            model.ResetIdentifierFields();
            model.SeasonId = Season.Id;
            model.EngineId = engine.Id;

            Model.SeasonEngines.Add(model);
        }
    }

    private async Task SetDefaultTeams()
    {
        List<SeasonTeam>? previousTeams = null;
        if (PreviousSeason != null)
            previousTeams = await EntrantService.GetSeasonTeams(PreviousSeason.Id);

        foreach (var team in Model.BaseTeams)
        {
            SeasonTeam? previousTeam = null;
            if (previousTeams != null)
                previousTeam = previousTeams.Find(e => e.TeamId == team.Id);

            var model = new EditSeasonTeamModel(previousTeam);
            model.ResetIdentifierFields();
            model.SeasonId = Season.Id;
            model.TeamId = team.Id;
            model.Team = team;

            Model.SeasonTeams.Add(model);
        }
    }

    private async Task SetDefaultDrivers()
    {
        List<SeasonDriver>? previousDrivers = null;
        if (PreviousSeason != null)
            previousDrivers = await EntrantService.GetSeasonDrivers(PreviousSeason.Id);

        int indexer = 0;
        foreach (var driver in Model.BaseDrivers)
        {
            SeasonDriver? previousDriver = null;
            if (previousDrivers != null)
                previousDriver = previousDrivers.Find(e => e.DriverId == driver.Id);

            var model = new EditSeasonDriverModel(previousDriver);
            model.ResetIdentifierFields();
            model.SeasonId = Season.Id;
            model.DriverId = driver.Id;
            model.Driver = driver;

            if (!_config.Value.PersonalNumbersEnabled)
                model.Number = ++indexer;

            Model.SeasonDrivers.Add(model);
        }
    }

    private async Task AddAllEntrants()
    {
        Model.CombineEntrantModels();

        var rootEntrants = Model.SeasonEngines.Select(e => e.Record).ToList();

        await EntrantService.PersistSeasonEntrants(rootEntrants);

        Nav.NavigateTo($"/overview/{SeasonId}");
    }

    private void TeamEngineDropped(MudItemDropInfo<EditSeasonTeamModel> dropItem)
    {
        if (dropItem.Item != null)
            dropItem.Item.BaseEngineId = long.Parse(dropItem.DropzoneIdentifier);
    }

    private void RefreshTeamEngine()
    {
        //update the binding to the container
        StateHasChanged();

        //the container refreshes the internal state
        _dropperTeams.Refresh();
    }

    private void DriverTeamDropped(MudItemDropInfo<EditSeasonDriverModel> dropItem)
    {
        if (dropItem.Item != null)
            dropItem.Item.BaseTeamId = long.Parse(dropItem.DropzoneIdentifier);
    }

    private void RefreshDriverTeam()
    {
        //update the binding to the container
        StateHasChanged();

        //the container refreshes the internal state
        _dropperDrivers.Refresh();
    }

    private string ReadManufacturerName(long id)
    {
        var manufacturer = manufacturers.Find(e => e.Id == id);
        if (manufacturer != null)
            return manufacturer.Name;

        return "None";
    }
}
