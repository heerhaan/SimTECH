@inject ClimateService _climateService
@inject LeagueService _leagueService
@inject RaceService _raceService
@inject TrackService TrackService
@inject NavigationManager Nav
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="px-0">
    <MudPaper MinHeight="60px">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="pa-4">
            <MudText Typo="Typo.h3">Races</MudText>
            <MudSpacer />
            @if (Season.State == State.Concept)
            {
                <MudButton StartIcon="@Icons.Material.Outlined.CarRepair"
                           IconColor="Color.Primary"
                           Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Size="Size.Large"
                           OnClick="AddRaces">
                    Add races
                </MudButton>
            }
        </MudStack>
    </MudPaper>
    <MudTable Items="@RaceCalendar" Dense="true">
        <HeaderContent>
            <MudTh Class="number-col">Round</MudTh>
            <MudTh>Country</MudTh>
            <MudTh>Race</MudTh>
            <MudTh>Weather</MudTh>
            <MudTh>Polesitter</MudTh>
            <MudTh Class="number-col">NO</MudTh>
            <MudTh>Winner driver</MudTh>
            <MudTh Class="number-col">NO</MudTh>
            <MudTh>Winner team</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd Class="number-col">
                <MudText Typo="Typo.caption">@context.Round</MudText>
            </MudTd>
            <MudTd>
                <CountryNamedFlag Code="@context.Country" Size="ElementSize.Small" Reverse="true" Class="overflow-hider" />
            </MudTd>
            <MudTd Style="max-width:300px">
                <MudText Class="overflow-hider">@context.Name</MudText>
            </MudTd>
            <MudTd>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                    <MudIcon Icon="@context.WeatherIcon" />
                    <MudText>@context.Weather</MudText>
                </MudStack>
            </MudTd>

            @if (context.PoleSitter != null)
            {
                <MudTd Style="max-width:250px">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Style="max-width:250px">
                        <MudText Class="overflow-hider">@context.PoleSitter.Name</MudText>
                        <MudSpacer />
                        <CountryFlag Code="@context.PoleSitter.Country" Size="ElementSize.Small" />
                    </MudStack>
                </MudTd>
                <MudTd Class="number-col">
                    <NumberDisplay Colour="@context.PoleSitter.Colour" Accent="@context.PoleSitter.Accent">@context.PoleSitter.Number</NumberDisplay>
                </MudTd>
            }
            else
            {
                <MudTd></MudTd>
                <MudTd Class="number-col"></MudTd>
            }

            @if (context.DriverWinner != null)
            {
                <MudTd Style="max-width:250px">
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudText Class="overflow-hider">@context.DriverWinner.Name</MudText>
                        <MudSpacer />
                        <CountryFlag Code="@context.DriverWinner.Country" Size="ElementSize.Small" />
                    </MudStack>
                </MudTd>
                <MudTd Class="number-col">
                    <NumberDisplay Colour="@context.DriverWinner.Colour" Accent="@context.DriverWinner.Accent">@context.DriverWinner.Number</NumberDisplay>
                </MudTd>
            }
            else
            {
                <MudTd Class="number-col"></MudTd>
                <MudTd></MudTd>
            }

            <MudTd>
                @if (context.TeamWinner != null)
                {
                    <MudText Typo="Typo.button" Class="overflow-hider">@context.TeamWinner.Name</MudText>
                }
            </MudTd>
            <MudTd>
                <MudButtonGroup Size="@Size.Small">
                    @if (Season.State == State.Active && (context.Round == _nextRound))
                    {
                        <MudIconButton Icon="@Icons.Material.Outlined.Logout" OnClick="@(() => GoToRaceWeek(context))" />
                    }
                    else if (context.State == State.Closed)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Flag" OnClick="@(() => GoToRaceWeek(context))" />
                    }
                    else if (Season.State != State.Closed)
                    {
                        <MudIconButton Icon="@Icons.Material.Outlined.Edit" OnClick="@(async () => await UpdateRace(context.RaceId))" />
                        <MudIconButton Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="@(async () => await DeleteRace(context.RaceId))" />
                    }
                </MudButtonGroup>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudContainer>

@code {
    [CascadingParameter] public Season Season { get; set; }

    List<CalendarRaceModel> RaceCalendar = new();
    List<Climate> Climates = new();
    int _nextRound;

    protected override async Task OnInitializedAsync()
    {
        RaceCalendar = await _raceService.GetRaceCalendar(Season.Id);
        Climates = await _climateService.GetClimates(StateFilter.All);

        _nextRound = (await _raceService.GetNextRaceOfSeason(Season.Id))?.Round ?? 0;
    }

    private async Task AddRaces()
    {
        var seasonLeague = await _leagueService.GetLeagueById(Season.LeagueId);
        var availableTracks = (await TrackService.GetTracks())
            .Where(e => !RaceCalendar.Select(r => r.TrackId).Contains(e.Id))
            .ToList();

        if (seasonLeague == null)
        {
            Snackbar.Add("how in the hell is it unknown which league this is, cant do shit now?!", Severity.Error);
            return;
        }

        if (!availableTracks.Any())
        {
            Snackbar.Add("there aren't any tracks left to add to this season, ya absolute willy", Severity.Error);
            return;
        }

        var parameters = new DialogParameters
            {
                ["Tracks"] = availableTracks,
                ["SeasonId"] = Season.Id,
                ["OffsetRound"] = (RaceCalendar.Count + 1),
                ["DefaultRaceLength"] = seasonLeague.RaceLength,
                ["Climates"] = Climates.Where(e => e.State == State.Active).ToList(),
            };

        var dialog = await DialogService.ShowAsync<AddRaces>("Insert races", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null && result.Data is List<Race> addedRaces)
        {
            await _raceService.InsertRaces(addedRaces);
            RaceCalendar = await _raceService.GetRaceCalendar(Season.Id);
        }
    }

    private async Task UpdateRace(long raceId)
    {
        var item = await _raceService.GetRaceById(raceId);
        var seasonLeague = await _leagueService.GetLeagueById(Season.LeagueId);

        if (seasonLeague == null)
        {
            Snackbar.Add("how in the hell is it unknown which league this is, cant do shit now?!", Severity.Error);
            return;
        }

        var parameters = new DialogParameters 
            {
                ["Race"] = item,
                ["SeasonId"] = Season.Id,
                ["IncomingRound"] = item.Round,
                ["DefaultRaceLength"] = seasonLeague.RaceLength,
                ["Climates"] = Climates.Where(e => e.State == State.Active).ToList(),
            };

        var dialog = await DialogService.ShowAsync<RaceEditor>("Modify Race", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null && result.Data is Race updatedRace)
        {
            await _raceService.UpdateRace(updatedRace);
            RaceCalendar = await _raceService.GetRaceCalendar(Season.Id);
        }
    }

    private async Task DeleteRace(long raceId)
    {
        await _raceService.DeleteRace(raceId);
        RaceCalendar.Remove(RaceCalendar.First(e => e.RaceId == raceId));
    }

    private async Task GoToRaceWeek(CalendarRaceModel race)
    {
        if (race.State == State.Concept)
        {
            if (race.Round != _nextRound)
            {
                Snackbar.Add("oi oi oi, a previous round hasn't been finished (or even started!) yet. do that one first, cunt.", Severity.Error);
                return;
            }

            await _raceService.ActivateRace(race.RaceId);
        }

        Nav.NavigateTo($"/raceweek/{race.RaceId}");
    }
}
