@page "/contractmanager"
@inject ContractService _contractService
@inject LeagueService _leagueService
@inject DriverService _driverService
@inject TeamService _teamService
@inject NavigationManager _nav

<PageTitle>Contract Manager</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudPaper MaxHeight="150px">
        <MudText Typo="Typo.h3" Class="mx-auto">Manage contracts</MudText>

        @if (Leagues is not null)
        {
            <ManagerSettings Leagues="Leagues" OnLoadSetting="HandleSettingLoad" />
        }
    </MudPaper>

    @if (showDropper)
    {
        <MudPaper Elevation="10">
            <ManagerDropper Teams="Teams" EditableContracts="EditableContracts" OnDriversDropped="HandleDriversDropped" />
        </MudPaper>
    }

    @if (showDurationAssigner)
    {
        <MudPaper Elevation="25">
            <ManagerDuration EditableContracts="EditableContracts" OnSave="SaveContracts" />
        </MudPaper>
    }
</MudContainer>

@code {
    private List<League>? Leagues { get; set; }
    private List<Contract> Contracts { get; set; } = new();
    private List<Team> Teams { get; set; } = new();
    private List<EditContract> EditableContracts { get; set; } = new();

    private bool showDropper = false;
    private bool showDurationAssigner = false;

    protected override async Task OnInitializedAsync()
    {
        var existingLeagues = await _leagueService.GetLeagues();
        Leagues = existingLeagues.Where(e => e.Options.HasFlag(LeagueOptions.AllowContracting)).ToList();
    }

    private async Task HandleSettingLoad(Tuple<long, bool, bool> settings)
    {
        showDurationAssigner = false;

        var selectedLeagueId = settings.Item1;
        var onlyCertainTeams = settings.Item2;
        var onlyCertainDrivers = settings.Item3;

        List<Team> teams;
        if (onlyCertainTeams)
            teams = await _teamService.GetLeagueTeams(selectedLeagueId);
        else
            teams = await _teamService.GetTeams();

        List<Driver> drivers;
        if (onlyCertainDrivers)
            drivers = await _driverService.GetLeagueDrivers(selectedLeagueId);
        else
            drivers = await _driverService.GetDrivers();

        var leagueContracts = await _contractService.GetLeagueContracts(selectedLeagueId);

        var editableContracts = leagueContracts.Select(e => new EditContract(e)).ToList();
        foreach (var editable in editableContracts)
        {
            editable.Team = teams.Find(e => e.Id == editable.TeamId);
            editable.Driver = drivers.Find(e => e.Id == editable.DriverId);
        }

        foreach (var freeAgent in drivers.Where(e => !editableContracts.Select(c => c.DriverId).Contains(e.Id)))
        {
            var agentContract = new EditContract(null);
            agentContract.DriverId = freeAgent.Id;
            agentContract.Driver = freeAgent;
            agentContract.LeagueId = selectedLeagueId;
            agentContract.Duration = 1;

            editableContracts.Add(agentContract);
        }

        Teams = teams;
        EditableContracts = editableContracts
            .Where(e => e.Driver != null)
            .OrderBy(e => e.Driver!.FirstName)
            .ToList();

        showDropper = true;
    }

    private void HandleDriversDropped(List<EditContract> editableContracts)
    {
        showDropper = false;

        EditableContracts = editableContracts;

        showDurationAssigner = true;
    }

    private async Task SaveContracts(List<Contract> addedContracts)
    {
        await _contractService.AddContracts(addedContracts);
        _nav.NavigateTo("contracts");
    }
}
