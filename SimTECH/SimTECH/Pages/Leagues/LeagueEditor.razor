<MudDialog>
    <TitleContent>
        <MudText>Modify league</MudText>
        <MudText>
            Keep in mind that race length is used to determine the amount of calcuations each race,
            which is why we round to 10 since every ten decimals amounts to one additional calculation.
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm Model="@model" @ref="form">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1">League settings</MudText>
                    <MudDivider />
                </MudItem>

                <MudItem xs="4">
                    <MudTextField T="string" @bind-Value="model.Name" Label="Name" Class="field-md" />
                    <MudNumericField T="int" @bind-Value="model.RaceLength" Min="0" Step="10" Label="Length (Km)" HelperText="Should round to nearest ten" Validation="@(new Func<int, string?>(LengthValidator))" Class="field-md" />
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle1">Options</MudText>
                    <MudStack>
                        <MudSwitchM3 @bind-Checked="model.UsePenalty" ThumbIcon="@Icons.Material.Filled.Done" ThumbOffIcon="@Icons.Material.Filled.Close" Label="Enable Penalties" Color="Color.Secondary" />
                        <MudSwitchM3 @bind-Checked="model.EnableFatality" ThumbIcon="@Icons.Material.Filled.Done" ThumbOffIcon="@Icons.Material.Filled.Close" Label="Enable Fatalities" Color="Color.Secondary" />
                    </MudStack>
                </MudItem>
                <MudItem xs="4">
                    @if (errorValidations.Any())
                    {
                        <MudList>
                            <MudListSubheader>Error messages</MudListSubheader>
                            @foreach (var error in errorValidations)
                            {
                                <MudListItem>
                                    <MudText Color="Color.Error">@error</MudText>
                                </MudListItem>
                            }
                        </MudList>
                    }
                </MudItem>

                <MudItem xs="6">
                    <MudPaper Elevation="5">
                        <RangeInput Items="_skillRanges" RangeType="RangeType.Skill"></RangeInput>
                    </MudPaper>
                </MudItem>

                <MudItem xs="6">
                    <MudPaper Elevation="5">
                        <RangeInput Items="_ageRanges" RangeType="RangeType.Age"></RangeInput>
                    </MudPaper>
                </MudItem>

                <MudItem xs="6">
                    <MudPaper Elevation="5">
                        <RangeInput Items="_teamRanges" RangeType="RangeType.Team"></RangeInput>
                    </MudPaper>
                </MudItem>

                <MudItem xs="6">
                    <MudPaper Elevation="5">
                        <RangeInput Items="_engineRanges" RangeType="RangeType.Engine"></RangeInput>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Ok</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] protected MudDialogInstance? LeagueDialog { get; set; }

    [Parameter] public League? League { get; set; }

    private MudForm? form;

    private EditLeagueModel model = new();
    private List<EditRangeModel> _skillRanges = new();
    private List<EditRangeModel> _ageRanges = new();
    private List<EditRangeModel> _teamRanges = new();
    private List<EditRangeModel> _engineRanges = new();

    private List<string> errorValidations = new();

    protected override void OnInitialized()
    {
        if (League != null)
        {
            model = new EditLeagueModel(League);
            _skillRanges = model.DevelopmentRanges.Where(e => e.Type == RangeType.Skill).ToList();
            _ageRanges = model.DevelopmentRanges.Where(e => e.Type == RangeType.Age).ToList();
            _teamRanges = model.DevelopmentRanges.Where(e => e.Type == RangeType.Team).ToList();
            _engineRanges = model.DevelopmentRanges.Where(e => e.Type == RangeType.Engine).ToList();
        }
    }

    private string? LengthValidator(int length)
    {
        if ((length % 10) != 0)
            return "Race length should be a factor of 10";

        return null;
    }

    private bool RunValidations()
    {
        var isValid = true;

        if ((model.RaceLength % 10) != 0)
        {
            errorValidations.Add("Race length should be a factor of 10");
            isValid = false;
        }

        return isValid;
    }

    private void Submit()
    {
        if (!RunValidations())
            return;

        var allRanges = new List<EditRangeModel>();
        allRanges.AddRange(_skillRanges);
        allRanges.AddRange(_ageRanges);
        allRanges.AddRange(_teamRanges);
        allRanges.AddRange(_engineRanges);

        model.DevelopmentRanges = allRanges;

        if (model.IsDirty)
        {
            var modLeague = model.Record;
            LeagueDialog?.Close(DialogResult.Ok(modLeague));
        }
    }

    private void Cancel() => LeagueDialog?.Cancel();
}
